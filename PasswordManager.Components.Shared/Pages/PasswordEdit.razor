@page "/password/{id:guid}/edit"
@page "/password/new"
@using PasswordManager.Services.Interfaces
@using PasswordManager.Models
@inject IPasswordItemService PasswordItemService
@inject ICategoryInterface CategoryService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<MudContainer MaxWidth="MaxWidth.Medium" Style="padding: 20px;">
    <MudStack Spacing="4">
        <!-- Header -->
        <MudPaper Class="pa-4" Style="background-color: #1e1e1e; color: white;">
            <MudText Typo="Typo.h4" Style="color: white;">
                <MudIcon Icon="@Icons.Material.Filled.Password" Size="Size.Large" Style="vertical-align: middle; margin-right: 8px;" />
                @(IsNewPassword ? "Add New Password" : "Edit Password")
            </MudText>
        </MudPaper>

        <!-- Password Form -->
        <MudPaper Class="pa-4" Style="background-color: #1e1e1e; color: white;">
            <MudForm @ref="form" Model="passwordItem" Validation="@(new Func<object, IEnumerable<string>>(ValidateModel))">
                <MudStack Spacing="3">
                    <MudTextField @bind-Value="passwordItem.Title" 
                                 Label="Title" 
                                 Variant="Variant.Outlined"
                                 Style="background-color: #2a2a2a;"
                                 For="@(() => passwordItem.Title)"
                                 Required="true" />
                    
                    <MudTextField @bind-Value="passwordItem.Username" 
                                 Label="Username" 
                                 Variant="Variant.Outlined"
                                 Style="background-color: #2a2a2a;"
                                 For="@(() => passwordItem.Username)" />
                    
                    <MudGrid>
                        <MudItem xs="12" md="8">
                            <MudTextField @bind-Value="passwordItem.Password" 
                                         Label="Password" 
                                         Variant="Variant.Outlined"
                                         InputType="@(isPasswordVisible ? InputType.Text : InputType.Password)"
                                         Style="background-color: #2a2a2a;"
                                         For="@(() => passwordItem.Password)"
                                         Required="true"
                                         Adornment="Adornment.End"
                                         AdornmentIcon="@(isPasswordVisible ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                                         OnAdornmentClick="TogglePasswordVisibility" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudButton Variant="Variant.Filled" 
                                      Color="Color.Secondary" 
                                      OnClick="GeneratePassword"
                                      FullWidth="true">
                                Generate
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                    
                    <MudTextField @bind-Value="passwordItem.WebsiteUrl" 
                                 Label="Website URL" 
                                 Variant="Variant.Outlined"
                                 Style="background-color: #2a2a2a;"
                                 For="@(() => passwordItem.WebsiteUrl)" />
                    
                    <MudTextField @bind-Value="passwordItem.Description" 
                                 Label="Notes" 
                                 Variant="Variant.Outlined"
                                 Lines="3"
                                 Style="background-color: #2a2a2a;"
                                 For="@(() => passwordItem.Description)" />
                    
                    <MudSelect @bind-Value="passwordItem.CategoryId" 
                              Label="Category" 
                              Variant="Variant.Outlined"
                              Style="background-color: #2a2a2a;">
                        @foreach (var category in categories)
                        {
                            <MudSelectItem Value="@category.Id">@category.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudStack>
            </MudForm>
        </MudPaper>

        <!-- Password Generator Options -->
        @if (showGeneratorOptions)
        {
            <MudPaper Class="pa-4" Style="background-color: #1e1e1e; color: white;">
                <MudText Typo="Typo.h6" Style="color: white; margin-bottom: 16px;">Password Generator Options</MudText>
                <MudStack Spacing="3">
                    <MudSlider @bind-Value="passwordLength" 
                              Min="8" 
                              Max="128" 
                              Step="1" 
                              Color="Color.Primary"
                              Text="@($"Length: {passwordLength}")" />
                    
                    <MudSwitch @bind-Value="includeUppercase" 
                              Label="Include Uppercase Letters" 
                              Color="Color.Primary" />
                    
                    <MudSwitch @bind-Value="includeLowercase" 
                              Label="Include Lowercase Letters" 
                              Color="Color.Primary" />
                    
                    <MudSwitch @bind-Value="includeNumbers" 
                              Label="Include Numbers" 
                              Color="Color.Primary" />
                    
                    <MudSwitch @bind-Value="includeSymbols" 
                              Label="Include Symbols" 
                              Color="Color.Primary" />
                    
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Secondary" 
                              OnClick="GeneratePassword">
                        Generate New Password
                    </MudButton>
                </MudStack>
            </MudPaper>
        }

        <!-- Actions -->
        <MudPaper Class="pa-4" Style="background-color: #1e1e1e; color: white;">
            <MudStack Row Spacing="2">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          OnClick="SavePassword"
                          Disabled="isSaving">
                    @if (isSaving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ml-2">Saving...</MudText>
                    }
                    else
                    {
                        <MudText>@(IsNewPassword ? "Add Password" : "Save Changes")</MudText>
                    }
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Secondary" 
                          OnClick="Cancel">
                    Cancel
                </MudButton>
                <MudButton Variant="Variant.Text" 
                          Color="Color.Info" 
                          OnClick="() => showGeneratorOptions = !showGeneratorOptions">
                    @(showGeneratorOptions ? "Hide" : "Show") Generator Options
                </MudButton>
            </MudStack>
        </MudPaper>
    </MudStack>
</MudContainer>

@code {
    [Parameter] public Guid? Id { get; set; }
    
    private PasswordItem passwordItem = new();
    private List<Category> categories = new();
    private MudForm? form;
    private bool isPasswordVisible = false;
    private bool isSaving = false;
    private bool showGeneratorOptions = false;
    
    // Password generator options
    private int passwordLength = 16;
    private bool includeUppercase = true;
    private bool includeLowercase = true;
    private bool includeNumbers = true;
    private bool includeSymbols = true;

    private bool IsNewPassword => Id == null || Id == Guid.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Check authentication
        var isAuthenticated = await AuthService.IsAuthenticatedAsync();
        if (!isAuthenticated)
        {
            Navigation.NavigateTo("/masterpassword");
            return;
        }

        await LoadCategories();
        
        if (!IsNewPassword)
        {
            await LoadPassword();
        }
        else
        {
            passwordItem = new PasswordItem
            {
                Id = Guid.NewGuid(),
                Type = ItemType.Password,
                CreatedAt = DateTime.UtcNow,
                LastModified = DateTime.UtcNow
            };
        }
    }

    private async Task LoadCategories()
    {
        try
        {
            categories = await CategoryService.GetAllAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading categories: {ex.Message}");
        }
    }

    private async Task LoadPassword()
    {
        try
        {
            if (Id.HasValue)
            {
                passwordItem = await PasswordItemService.GetByIdAsync(Id.Value) ?? new PasswordItem();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading password: {ex.Message}");
        }
    }

    private void TogglePasswordVisibility()
    {
        isPasswordVisible = !isPasswordVisible;
    }

    private void GeneratePassword()
    {
        var chars = "";
        if (includeUppercase) chars += "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        if (includeLowercase) chars += "abcdefghijklmnopqrstuvwxyz";
        if (includeNumbers) chars += "0123456789";
        if (includeSymbols) chars += "!@#$%^&*()_+-=[]{}|;:,.<>?";

        if (string.IsNullOrEmpty(chars))
        {
            chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        }

        var random = new Random();
        var password = new string(Enumerable.Repeat(chars, passwordLength)
            .Select(s => s[random.Next(s.Length)]).ToArray());

        passwordItem.Password = password;
    }

    private async Task SavePassword()
    {
        try
        {
            isSaving = true;
            
            if (form != null)
            {
                await form.Validate();
                if (!form.IsValid)
                {
                    return;
                }
            }

            passwordItem.LastModified = DateTime.UtcNow;

            if (IsNewPassword)
            {
                await PasswordItemService.CreateAsync(passwordItem);
            }
            else
            {
                await PasswordItemService.UpdateAsync(passwordItem);
            }

            Navigation.NavigateTo("/vault");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving password: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private void Cancel()
    {
        if (IsNewPassword)
        {
            Navigation.NavigateTo("/vault");
        }
        else
        {
            Navigation.NavigateTo($"/password/{Id}");
        }
    }

    private IEnumerable<string> ValidateModel(object model)
    {
        var item = model as PasswordItem;
        if (item == null) yield break;

        if (string.IsNullOrEmpty(item.Title))
            yield return "Title is required";

        if (string.IsNullOrEmpty(item.Password))
            yield return "Password is required";
    }
}
